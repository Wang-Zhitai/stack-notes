# 系统滴答计时器是什么？

系统滴答计时器（SysTick）是一种简单的定时器，它是 Cortex - M 内核的一个内置外设，存在于基于 Cortex - M 架构的微控制器中，如 STM32 系列芯片。它主要用于产生定期的中断，为操作系统或其他需要定时功能的应用程序提供一个基本的时间基准。

 SysTick 定时器是一个 24 位的递减计数器。当计数器从初始值递减到 0 时，会产生一个中断请求（如果中断使能），并且计数器会自动重装初始值，然后继续递减计数，如此循环往复，以固定的频率产生中断。

# 工作原理

- **时钟源选择**：SysTick 定时器有两种时钟源可供选择。一种是外部时钟（通常是处理器的主时钟），另一种是处理器的内部时钟（一般是系统时钟经过一定分频后得到）。

- **计数频率确定**：根据所选的时钟源和相关的分频设置，可以确定 SysTick 定时器的计数频率。假设选择的时钟源频率为，分频系数为，那么 SysTick 定时器的计数频率。当计数器从初始值（这是一个 24 位的值）递减到 0 的时间，这个时间就是 SysTick 定时器的中断周期。

- **中断产生与处理**：当计数器递减到 0 时，会触发 SysTick 中断。在中断服务函数中，可以执行一些周期性的任务，如系统调度（对于操作系统而言）、任务切换、时间片轮转或者简单的定时数据采集等操作。

# 应用场景

* 为RTOS提供时间节拍（TICK）
* 简单的定时任务
* 延迟函数的实现

# 延迟函数示例代码（以STM32F407ZGT6举例）

```c
/*
SysTick 控制与状态寄存器（STK_CTRL）：
地址：0xE000E010。它是一个 32 位寄存器，用于控制 SysTick 定时器的运行和获取其状态。

位 0（ENABLE）：使能 SysTick 定时器。当此位为 1 时，定时器开始计数；为 0 时停止计数。

位 1（TICKINT）：SysTick 中断使能位。当该位为 1 时，定时器计数到 0 会产生中断；为 0 则不产生中断，但定时器仍正常计数和重装。

位 2（CLKSOURCE）：用于选择 SysTick 定时器的时钟源。0 表示选择外部参考时钟（通常是处理器的时钟源经过一定分频），1 表示选择处理器的内核时钟。

位 16（COUNTFLAG） - 计数到 0 标志位：这是一个只读位，用于指示 SysTick 定时器是否已经计数到 0。当定时器计数到 0 时，该位会被自动设置为 1；在读取该位或者向该位写入 0 后，此位会被自动清除。在软件实现定时功能时，通常会在一个循环中不断检查这个位，以确定定时周期是否结束。例如，在一个简单的延时函数中，可以通过等待这个位变为 1 来确定延时时间已经达到。

SysTick 重装载值寄存器（STK_LOAD）：
地址：0xE000E014。这是一个 24 位寄存器，用于设置 SysTick 定时器每次计数的重装值。例如，若要实现特定的延时或定时周期，通过合理设置这个值来确定计数的周期长度。

SysTick 当前值寄存器（STK_VAL）：
地址：0xE000E018。这是一个 24 位寄存器，用于读取当前定时器的计数值。在启动定时器前，通常会将此值清零，以确保计数从 0 开始。
*/

// 延时微秒级函数
void Delay_us(uint32_t us)
{
    // 对于STM32F407ZGT6，默认系统时钟频率为168MHz

	// 一秒168 000 000次时钟，除以1 000 000就是一us的时钟次数计算需要的时钟节拍数
    uint32_t ticks = (SystemCoreClock / 1000000) * us;  
    SysTick->LOAD = ticks - 1;  // 设置系统滴答计时器重载值，减1是因为从0开始计数到LOAD值是LOAD+1次计数
    SysTick->VAL = 0;  // 清空当前计数值
    SysTick->CTRL = 0x00000005;  //0x05是0101：设置时钟源为系统内核时钟，使能计数器，开启SysTick定时器
    while (!(SysTick->CTRL & 0x00010000));  // 等待计数到0，即延时结束，该位为1表示计数到0
    SysTick->CTRL = 0;  // 关闭SysTick定时器，停止计数
}

// 延时毫秒级函数（基于上面的微秒级函数来实现）
void Delay_ms(uint32_t ms)
{
    for (uint32_t i = 0; i < ms; i++)
    {
        Delay_us(1000);  // 调用微秒级延时函数，每次延时1000微秒即1毫秒，循环多次达到毫秒级延时
    }
}
```