# 字符设备驱动

late_init是最后加载的

# 1. Linux应用程序如何调用驱动程序

* 字符设备是Linux驱动中最基本的一类设备驱动，字符设备就是一个一个字节按照字节流进行读写操作的设备，读写数据是分先后数据的，比如我们最常见的点灯、按键、I2C、SPI LCD等都是字符设备，这些设备的驱动就叫做字符设备驱动。

* 先来了解一下Linux下的应用程序是如何调用驱动程序的，调用流程如图所示：

![image-20251127081434493](./assets/image-20251127081434493.png)

* `在Linux中，一切皆文件`，驱动加载成功后，会在/dev目录下面生成一个相对应的文件。应用程序通过对这个名为/dev/xxx的文件进行相应的操作，即可实现对硬件的操作。比如我现在有一个叫做/dev/led的驱动文件，此文件是LED灯的驱动文件。应用程序通过`open`函数打开文件，使用完成后使用`close`函数关闭文件。 Open和close就是打开和关闭LED驱动的函数。如果要点亮或者关闭LED，那就使用write函数来操作，也就是向此函数写入数据。这个数据就是是要关闭还是打开LED的控制参数。如果要获取LED灯的状态。就用read函数从驱动中读取相应的状态。

* 应用程序运行在用户空间，而Linux驱动运行于内核空间。当我们在用户空间想要实现对内核的操作，比如使用open函数打开LED驱动，因为用户空间不能直接对内核进行操作，因此必须使用一个叫做`系统调用`的方法来实现从`用户空间陷入到内核空间`，这样才能实现对底层驱动的操作。open、close、write、read这些函数是由C库提供的。在Linux系统中，系统调用作为C库的一部分。当我们调用open函数的时候的流程如图所示：

![image-20251127082425023](./assets/image-20251127082425023.png)





# 2. Linux设备号

# 3. 驱动模块的加载和卸载

# 4. 文件私有数据

# 5. 字符设备注册

# 6. 代码示例



